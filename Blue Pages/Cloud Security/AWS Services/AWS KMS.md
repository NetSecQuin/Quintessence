# AWS KMS (Key Management Service)
![](https://explore.skillbuilder.aws/files/a/w/aws_prod1_docebosaas_com/1721163600/qQMAeir7CedYq2w0pM_zlw/tincan/1795780_1704469401_o_1hjd4l7tc11hedc913i09dklbhj_zip/assets/1YENN4HcmHCiFULV_MgSDd8HPSRE12EKm.png)


## Summary

AWS Key Management Service (AWS KMS) is a managed service that helps you to create and control the keys used in data encryption. If you want a managed service for creating and controlling encryption keys, but do not want or need to operate your own HSM, consider using AWS KMS. You can use the key management and cryptographic features directly in your applications or through AWS services that are integrated with AWS KMS. This includes AWS CloudTrail, which helps meet your auditing, regulatory, and compliance needs.

More information on [AWS Key Management](https://aws.amazon.com/kms/).

## Use

- Create and manage crypotgraphic keys used for data encryption, without operating your own HSM.

![](https://d1.awsstatic.com/Security/aws-kms/Group%2017aws-kms.6dc3dbbbe5b75b46c4f62218d0531e5bed7276ce.png)


## Key Management Service (KMS)
- Regional & Public Service
- Create , Store and Manage Symmetric and Asymmetric Keys
- The service provides cryptographic operations (encrypt, decrpyt)
- Keys never leave KMS Service to Provide FIPS 140-2 (L2)

### KMS Keys
- KMS Keys are logical and consist of an ID, date, policy, description, and state. They are backed by **physical key material**
- Keys can either be generated by the KMS service or importated
- KMS Keys can be used for encryption up to 4KB of data. It is used for generating other keys when encrypting larger amounts of data via a Data Encryption Key (DEK)
  - KMS will not store or track the usage of the DEKs for you. Either you will store it, or the service you are using will store it (Ex. S3 SSE w/ DEKs)
- KMS Keys have resource policies (Key Policy) that describe what AWS account is allowed to use it. It does not follow the Implicit trust that other AWS Services do.
  - Ex. When you create an S3 bucket in an AWS account, the S3 resource policy implicitly trusts the AWS Account. With KMS the Key Policy is restricted to all accounts unless explicitly configured. 

### Importing Key Material vs Generating Key Material
You can generate key material with KMS or you can bring your own key (BYOK). 
- You can only import Key material if its an **Symmetric Key**
- BYOK is used for sume regulated industries for compliance
- Same key material inside and outside of AWS (on-prem)
- KMS Generated keys can not be immediately deleted or resotred. (7-30 day deletion timer) BYOK or customer provided key material can be deleted immediately
  - Immidate key deletion and key restoration is useful in disaster recovery situations
  - Keep key material outside of AWS for disater recovery also
- Once you have added Key Material to a KMS Key, you can not change the Key Material. (no auto rotation) you can manualy rotate.
-  Imported keys originate from AWS KMS, External Sources, or AWS CloudHSM
-  Deleting an imported key just deletes the key material, not the KMS key metadata. Which allows you to re-import the same Key Material and reuse the KMS key. 

### AWS Managed Keys
- Created by AWS when you use encryption in a service
- 1 per service per region  and named like aws/s3
- Usable by that service in that region only
- metadata can be read by the creator of the AWS account
- The key policy (resource policy) can **not** be changed. It is AWS managed. It will be rotated every 365 datys by AWS by default.
- No monthly cost , but has usage costs if you go past the free tier
- No cross-account usage due to the fixed key policy which locks it to the AWS account


### Customer Managed Keys (CMK)
- Are more configurable and can allow cross account access as you have full control of the key policy.
- This also means that the account trust restriction can be removed, or you can specific which accounts can use it. Restriciting access to AWS account administrators. 
- Can be used by services whihc support customer managed keys (CMS)
- CMK keys **can** be rotated automatacially , but the default is 365 days, but it is set to disabled by default. 


### Asymmetric Keys in KMS
- Key Pair (Private & Public) Private key never leaves KMS
- Public Key can be downloaded via console or CLI (kms:GetPublicKey
- RSA - Encrypt/Decrypt, Signing and Verification, but not both.
- Elliptical Curve (ECC) can be used for signing and verification
- AWS services which use KMS will use Symmetric keys not Asymmetric
- KeySpec = ENCRPYT_DECRYPT | SIGN_VERIFY (cant be changed)

### Digital Signing using Asymmetric KMS Keys
When you need to improve integrity of a file that ensures it was not alterned. 
- File (if less than 4KB) or the hash is submitted to KMS using the SIGN API call. It will tell KMS which via the MessageType parameter in the request
- KMS uses the private key part to create a signature of the hash (this is signing). KMS uses the public key to verify that the hash matches the signature to ensure integrity. 

### Encryption SDK
- A client-side encrpyiton librabry (apache 2.0 license) that you can build into your application for encryption to be handled in the application
- Handles data key and many (AWS/On-Prem) wrapping keys
- If your application used encryption the ecnryption SDK will save you time with setting up encryption
- By default a unique data key is used for every encryption
- KMS rate limits are something to keep in mind. GenerateDataKey limits 50K requests accross us-east1, us-west-2, and eu-west-1. It is 10K for some others like us-east-2 and ap-sourtheast-1, and 5.5K for the rest. 
- Crpytographic Materials Cache (CMM) can be configured to describe how long a cached key will be utilizied
- Does not need to use KMS can assist with adding encryption to applications that do not use KMS.

### KMS Grants
- Temporary access rights for a key policy
- Greats allow permissions on 1 KMS key, and generally used by an AWS service where you are provisioning the least permssion access.
- Grants cant DENY. They are retired once the task is complete.
- Grantee Principal = identity who can use the grant. Operations can be used without specifiying the grant.
- Grant tokens are short lived (5minutes) 


### Multi-Region KMS Keys
- Can be imported or genreated but must be configured as either single account or multi-region at creation. 
- Works by creating replica keys, which are independant copies of the keys entirely except that the enable/disable state is not replicated.
- Useful for disaster recovery when one region goes down and digital signing.

### KMS vs CloudHSM
- KSM - If you need AWS product integrations
- KMS - Standard AWS API and access methods
- KMS - FIPS Validated HSMs if you are okay with shared HSMs. FIPS Level 3 requires a dedicated HSM
- CloudHSM - Standard APIs, Dedicated and Self Managed, and FIPS 140-2 Level 3


### KMS Custom Key Stores
- A mix of KMS and CloudHSM
- Self hosted HSM in your Cloud VPC on dedicated hardware
- Gets you FIPS 140-2 Level 3
- Accessible via KMS APIs
- Does not support mult-region keys
- Only supports symmetric keys
- doesnt support automatic key rotation
- "kmsuser" is created on the cloudHSM cluster


### KMS Encryption Context
Used to validate the integrity of the data with the use of Additional Authenticated Data (AAD)
- Once data is encrypted, how can you be sure that the cipher text was not manipulated. This solves that by adding additional context to each value assoicating it to contextual values.
